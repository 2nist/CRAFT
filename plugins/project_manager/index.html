<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Manager Plugin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root { --plugin-bg: #111827; --plugin-text: #e5e7eb; --plugin-text-light: #9ca3af; --plugin-border: #374151; --plugin-primary: #3b82f6; --plugin-primary-hover: #2563eb; --plugin-bg-light: #1f2937; --plugin-bg-dark: #0f172a; }
        body { background-color: var(--plugin-bg); color: var(--plugin-text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
        .plugin-scrollbar::-webkit-scrollbar { width: 8px; }
        .plugin-scrollbar::-webkit-scrollbar-track { background: var(--plugin-bg-light); }
        .plugin-scrollbar::-webkit-scrollbar-thumb { background: var(--plugin-border); border-radius: 4px; }
        .plugin-scrollbar::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--plugin-primary); color: white; }
        .btn-primary:hover { background-color: var(--plugin-primary-hover); }
        .btn-secondary { background-color: var(--plugin-bg-light); color: var(--plugin-text); border: 1px solid var(--plugin-border); }
        .btn-secondary:hover { background-color: var(--plugin-border); }
        .input-base { background-color: var(--plugin-bg-light); border: 1px solid var(--plugin-border); color: var(--plugin-text); border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--plugin-border); }
        .table th { background-color: var(--plugin-bg-light); font-weight: 600; }
        .table tbody tr:hover { background-color: var(--plugin-bg-light); }
        .tab { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: var(--plugin-text-light); cursor: pointer; }
        .tab-active { color: var(--plugin-primary); border-bottom-color: var(--plugin-primary); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- React App ---
        const { useState, useEffect, useMemo, createContext, useContext } = React;

        // --- React Components ---

        const Tabs = ({ children }) => <div className="w-full">{children}</div>;
        const TabsList = ({ children }) => <div className="inline-flex h-9 items-center justify-center rounded-lg bg-gray-100 p-1 text-gray-500">{children}</div>;
        const TabsTrigger = ({ isActive, onClick, children }) => <button onClick={onClick} className={`inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium transition-all ${isActive ? 'bg-white text-gray-900 shadow' : 'text-gray-500'}`}>{children}</button>;
        const TabsContent = ({ isActive, children }) => <div className={isActive ? 'mt-2' : 'hidden'}>{children}</div>;

        function App() {
            const [activeTab, setActiveTab] = useState('pipedrive');

            return (
                <div className="p-4 md:p-6 min-h-screen plugin-scrollbar">
                    <Header />
                    
                    <Tabs>
                        <TabsList>
                            <TabsTrigger isActive={activeTab === 'pipedrive'} onClick={() => setActiveTab('pipedrive')}>
                                <svg className="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12,2 2,7 12,12 22,7 12,2"></polygon><polyline points="2,17 12,22 22,17"></polyline><polyline points="2,12 12,17 22,12"></polyline></svg>
                                Pipedrive Deals
                            </TabsTrigger>
                            <TabsTrigger isActive={activeTab === 'quotes'} onClick={() => setActiveTab('quotes')}>
                                <svg className="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>
                                Existing Quotes
                            </TabsTrigger>
                        </TabsList>

                        <TabsContent isActive={activeTab === 'pipedrive'}>
                            <PipedriveManager />
                        </TabsContent>
                        <TabsContent isActive={activeTab === 'quotes'}>
                            <QuoteManager />
                        </TabsContent>
                    </Tabs>
                </div>
            );
        }

        function Header() {
            // The agent will replace window.api.app.loadPlugin with the real call
            const handleNewQuote = () => {
                window.app.loadPlugin('quote-new', { isNew: true });
            };

            return (
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold text-white">Project Manager</h1>
                        <p className="text-sm text-gray-400">Dashboard for all quotes and Pipedrive deals.</p>
                    </div>
                    <button onClick={handleNewQuote} className="btn btn-primary">
                        <svg className="w-[18px] h-[18px] mr-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                        New Quote
                    </button>
                </div>
            );
        }

        function Header() {
            const [deals, setDeals] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");

            // The agent will replace window.api.pipedrive.getDeals
            const fetchDeals = async () => {
                setIsLoading(true);
                try {
                    const fetchedDeals = await window.pipedrive.getDeals();
                    setDeals(fetchedDeals);
                } catch (err) {
                    console.error("Failed to fetch Pipedrive deals:", err);
                }
                setIsLoading(false);
            };

            // The agent will replace window.api.app.loadPlugin
            const handleSelectDeal = (deal) => {
                const context = {
                    pipedriveDeal: deal,
                    isNew: true
                };
                window.app.loadPlugin('quote-new', context);
            };

            const filteredDeals = useMemo(() => {
                return deals.filter(deal => 
                    deal.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    deal.org_name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [deals, searchTerm]);

            return (
                <div className="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                    <div className="p-4 flex justify-between items-center border-b border-gray-700">
                        <div className="relative w-full max-w-xs">
                            <input
                                type="text"
                                placeholder="Search deals..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="input-base pl-10"
                            />
                            <svg className="w-[18px] h-[18px] absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                        </div>
                        <button onClick={fetchDeals} disabled={isLoading} className="btn btn-secondary">
                            {isLoading ? (
                                <svg className="w-[18px] h-[18px] mr-2 animate-spin" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>
                            ) : (
                                <svg className="w-[18px] h-[18px] mr-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>
                            )}
                            Fetch Deals
                        </button>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Deal Title</th>
                                    <th>Organization</th>
                                    <th>Owner</th>
                                    <th>Stage</th>
                                    <th>Value</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {isLoading && (
                                    <tr><td colSpan="6" className="text-center p-6 text-gray-400">Loading Pipedrive deals...</td></tr>
                                )}
                                {!isLoading && filteredDeals.length === 0 && (
                                    <tr><td colSpan="6" className="text-center p-6 text-gray-400">
                                        {deals.length === 0 ? 'Click "Fetch Deals" to load data from Pipedrive.' : 'No deals found matching your search.'}
                                    </td></tr>
                                )}
                                {!isLoading && filteredDeals.map(deal => (
                                    <tr key={deal.id} className="hover:bg-gray-700/50">
                                        <td className="font-medium text-white">{deal.title}</td>
                                        <td className="text-gray-300">{deal.org_name}</td>
                                        <td className="text-gray-300">{deal.owner_name}</td>
                                        <td className="text-gray-300">
                                            <span className="px-2 py-1 text-xs font-medium rounded-full bg-blue-900 text-blue-300">{deal.stage}</span>
                                        </td>
                                        <td className="text-gray-300">${deal.value.toLocaleString()}</td>
                                        <td>
                                            <button onClick={() => handleSelectDeal(deal)} className="btn btn-primary btn-sm py-1 px-2 text-sm">
                                                Create Quote
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function QuoteManager() {
            const [quotes, setQuotes] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");

            // The agent will replace window.api.quotes.getAll
            const fetchQuotes = async () => {
                setIsLoading(true);
                try {
                    const fetchedQuotes = await window.quotes.getAll();
                    setQuotes(fetchedQuotes);
                } catch (err) {
                    console.error("Failed to fetch quotes:", err);
                }
                setIsLoading(false);
            };

            // Load quotes on component mount
            useEffect(() => {
                fetchQuotes();
            }, []);

            // The agent will replace window.api.app.loadPlugin
            const handleEditQuote = (quote) => {
                const context = {
                    quoteId: quote.quoteId,
                    isNew: false
                };
                window.app.loadPlugin('quote-new', context);
            };
            
            // The agent will replace window.api.quotes.delete
            const handleDeleteQuote = async (quote) => {
                if (confirm(`Are you sure you want to delete "${quote.projectName}"?`)) {
                    setIsLoading(true);
                    try {
                        await window.quotes.delete(quote.quoteId);
                        // Refresh the list after deletion
                        await fetchQuotes();
                    } catch (err) {
                        console.error("Failed to delete quote:", err);
                        alert("Error: Could not delete quote.");
                    }
                    setIsLoading(false);
                }
            };
            
            const handleGenerateDocument = (quote) => {
                alert(`(Simulation) Generating document for: ${quote.quoteId}\n\nThis will trigger Phase 2 (BOM expansion, costing, and document generation).`);
            }

            const filteredQuotes = useMemo(() => {
                return quotes.filter(quote => 
                    quote.projectName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    quote.quoteId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    quote.customer.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [quotes, searchTerm]);

            return (
                <div className="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                    <div className="p-4 flex justify-between items-center border-b border-gray-700">
                        <div className="relative w-full max-w-xs">
                            <input
                                type="text"
                                placeholder="Search quotes..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="input-base pl-10"
                            />
                            <svg className="w-[18px] h-[18px] absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                        </div>
                    </div>
                    
                    <div className="overflow-x-auto">
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>Quote ID</th>
                                    <th>Customer</th>
                                    <th>Status</th>
                                    <th>Last Modified</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {isLoading && (
                                    <tr><td colSpan="6" className="text-center p-6 text-gray-400">Loading existing quotes...</td></tr>
                                )}
                                {!isLoading && filteredQuotes.length === 0 && (
                                    <tr><td colSpan="6" className="text-center p-6 text-gray-400">
                                        No existing quotes found.
                                    </td></tr>
                                )}
                                {!isLoading && filteredQuotes.map(quote => (
                                    <tr key={quote.quoteId} className="hover:bg-gray-700/50">
                                        <td className="font-medium text-white">{quote.projectName}</td>
                                        <td className="text-gray-400 font-mono text-xs">{quote.quoteId}</td>
                                        <td className="text-gray-300">{quote.customer}</td>
                                        <td className="text-gray-300">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                                quote.status === 'Draft' ? 'bg-yellow-900 text-yellow-300' : 'bg-green-900 text-green-300'
                                            }`}>{quote.status}</span>
                                        </td>
                                        <td className="text-gray-300 text-sm">{new Date(quote.lastModified).toLocaleString()}</td>
                                        <td className="text-right">
                                            <div className="flex gap-2">
                                                <button onClick={() => handleGenerateDocument(quote)} className="btn btn-secondary btn-sm py-1 px-2 text-sm">
                                                    Generate Doc
                                                </button>
                                                <button onClick={() => handleEditQuote(quote)} className="btn btn-primary btn-sm py-1 px-2 text-sm">
                                                    Edit
                                                </button>
                                                <button onClick={() => handleDeleteQuote(quote)} className="text-gray-500 hover:text-red-500 p-1">
                                                    <svg className="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- Mount App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>