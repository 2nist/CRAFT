<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Configurator Plugin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root { --plugin-bg: #111827; --plugin-text: #e5e7eb; --plugin-text-light: #9ca3af; --plugin-border: #374151; --plugin-primary: #3b82f6; --plugin-primary-hover: #2563eb; --plugin-bg-light: #1f2937; --plugin-bg-dark: #0f172a; }
        body { background-color: var(--plugin-bg); color: var(--plugin-text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
        .plugin-scrollbar::-webkit-scrollbar { width: 8px; }
        .plugin-scrollbar::-webkit-scrollbar-track { background: var(--plugin-bg-light); }
        .plugin-scrollbar::-webkit-scrollbar-thumb { background: var(--plugin-border); border-radius: 4px; }
        .plugin-scrollbar::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--plugin-primary); color: white; }
        .btn-primary:hover { background-color: var(--plugin-primary-hover); }
        .btn-secondary { background-color: var(--plugin-bg-light); color: var(--plugin-text); border: 1px solid var(--plugin-border); }
        .btn-secondary:hover { background-color: var(--plugin-border); }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .input-base { background-color: var(--plugin-bg-light); border: 1px solid var(--plugin-border); color: var(--plugin-text); border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-base:focus { outline: none; border-color: var(--plugin-primary); box-shadow: 0 0 0 2px var(--plugin-bg), 0 0 0 4px var(--plugin-primary); }
        .label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--plugin-text-light); }
        .wizard-tabs { display: flex; border-bottom: 1px solid var(--plugin-border); }
        .wizard-tab { flex: 1; padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--plugin-text-light); border-bottom: 4px solid transparent; cursor: pointer; transition: color 0.2s, border-color 0.2s; }
        .wizard-tab-active { color: var(--plugin-primary); border-bottom-color: var(--plugin-primary); }
        .wizard-tab-disabled { color: #4b5563; cursor: not-allowed; }
        .form-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1rem; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- React App ---
        const { useState, useEffect, useMemo, createContext, useContext } = React;

        // --- API Functions ---
        const normalizeSchemaOptions = (options = []) =>
            options.map(option => {
                const code = option.code ?? option.const;
                return code !== undefined ? { ...option, code } : option;
            });

        const getSchemas = async () => ({
            industry: normalizeSchemaOptions(await window.schemas.getIndustry()),
            product: normalizeSchemaOptions(await window.schemas.getProduct()),
            control: normalizeSchemaOptions(await window.schemas.getControl()),
            scope: normalizeSchemaOptions(await window.schemas.getScope()),
        });

        const getCustomers = async () => await window.customers.getAll();
        const useApi = () => {
            const [isLoading, setIsLoading] = useState(false);

            const saveQuote = (quote) => {
                setIsLoading(true);
                return window.quotes.save(quote).finally(() => setIsLoading(false));
            };

            const loadQuote = (quoteId) => {
                setIsLoading(true);
                return window.quotes.getById(quoteId).finally(() => setIsLoading(false));
            };

            const getSchemas = () => ({
                industry: window.schemas.getIndustry().then(normalizeSchemaOptions),
                product: window.schemas.getProduct().then(normalizeSchemaOptions),
                control: window.schemas.getControl().then(normalizeSchemaOptions),
                scope: window.schemas.getScope().then(normalizeSchemaOptions),
            });

            const getCustomers = () => window.customers.getAll();

            const searchAssemblies = (criteria) => {
                return window.assemblies.search(criteria);
            };

            return { saveQuote, loadQuote, getSchemas, getCustomers, searchAssemblies, isLoading };
        };
// --- Helper Components ---

function SelectCode({ label, value, onFieldChange, options, fieldName, filter = null }) {
    const groupedOptions = useMemo(() => {
        if (!options.some(o => o.category)) return null;
        return options.reduce((acc, option) => {
            const group = option.category || "General";
            if (!acc[group]) acc[group] = [];
            acc[group].push(option);
            return acc;
        }, {});
    }, [options]);

    const filteredOptions = useMemo(() => {
        if (!filter) return options;
        return options.filter(filter);
    }, [options, filter]);
    
    const renderOptions = (opts) => opts.map(option => (
        <option key={option.code} value={option.code}>
            {option.description} ({option.code})
        </option>
    ));

    return (
        <div className="w-full">
            <label className="label">{label}</label>
            <select
                className="input-base"
                value={value ?? ""}
                onChange={e => {
                    const selectedValue = e.target.value;
                    if (selectedValue === "") {
                        onFieldChange(fieldName, "");
                        return;
                    }
                    const parsedValue = parseInt(selectedValue, 10);
                    onFieldChange(fieldName, Number.isNaN(parsedValue) ? "" : parsedValue);
                }}
            >
                <option value="" disabled>Select...</option>
                {groupedOptions ? (
                    Object.keys(groupedOptions).sort().map(group => (
                        <optgroup key={group} label={group}>
                            {renderOptions(groupedOptions[group])}
                        </optgroup>
                    ))
                ) : (
                    renderOptions(filteredOptions)
                )}
            </select>
        </div>
    );
}

function SelectCustomer({ label, value, onFieldChange, customers }) {
    return (
        <div className="w-full">
            <label className="label">{label}</label>
            <select
                className="input-base"
                value={value || ""}
                onChange={e => {
                    const custId = e.target.value;
                    const cust = customers.find(c => c.id === custId);
                    onFieldChange("customer", custId);
                    // Pre-fill project name if empty
                    onFieldChange("projectName", (prev) => prev || `${cust.name} - New Project`);
                }}
            >
                <option value="" disabled>Select customer...</option>
                {customers.map(customer => (
                    <option key={customer.id} value={customer.id}>
                        {customer.name} ({customer.id})
                    </option>
                ))}
            </select>
        </div>
    );
}

function Input({ label, value, onFieldChange, fieldName, type = "text", placeholder = "" }) {
    return (
        <div className="w-full">
            <label className="label">{label}</label>
            <input
                type={type}
                placeholder={placeholder}
                className="input-base"
                value={value || ""}
                onChange={e => onFieldChange(fieldName, e.target.value)}
            />
        </div>
    );
}

function Select({ label, value, onFieldChange, fieldName, children }) {
    return (
        <div className="w-full">
            <label className="label">{label}</label>
            <select
                className="input-base"
                value={value || ""}
                onChange={e => onFieldChange(fieldName, e.target.value)}
            >
                {children}
            </select>
        </div>
    );
}
// --- Step 1: Project Details ---
function ProjectDetails({ quote, setQuote, schemas, customers, generatedNumber, setGeneratedNumber }) {
    
    const handleFieldChange = (field, value) => {
        setQuote(prev => ({
            ...prev,
            [field]: typeof value === 'function' ? value(prev[field]) : value
        }));
    };
    
    const handleCodeChange = (field, value) => {
        setQuote(prev => ({
            ...prev,
            projectCodes: { ...prev.projectCodes, [field]: value }
        }));
    };

    const generateQuoteId = () => {
        const now = new Date();
        const yy = now.getFullYear().toString().slice(-2);
        const mm = (now.getMonth() + 1).toString().padStart(2, '0');
        const dd = now.getDate().toString().padStart(2, '0');
        const cust = quote.customer || "XX";
        const seq = "0"; // Sequence number, hardcoded for this mock
        
        const mainId = `CQ${yy}${mm}${dd}${cust}`;
        const fullId = `${mainId}-${quote.projectCodes.industry || 'XX'}${quote.projectCodes.product || 'XXX'}${quote.projectCodes.control || 'X'}${quote.projectCodes.scope || 'XX'}-${seq}`;
        
        setGeneratedNumber(mainId); // Set the display number
        setQuote(prev => ({ ...prev, quoteId: fullId }));
    };

    return (
        <div className="space-y-6">
            <div className="p-4 bg-gray-800 rounded-lg shadow">
                <h3 className="text-lg font-semibold text-white mb-4">Core Project Details</h3>
                <div className="form-grid">
                    <SelectCustomer
                        label="Customer"
                        value={quote.customer}
                        onFieldChange={handleFieldChange}
                        customers={customers}
                    />
                    <Input
                        label="Project Name"
                        fieldName="projectName"
                        value={quote.projectName}
                        onFieldChange={handleFieldChange}
                        placeholder="E.g., Brewhouse Expansion"
                    />
                    <Input
                        label="Sales Rep"
                        fieldName="salesRep"
                        value={quote.salesRep}
                        onFieldChange={handleFieldChange}
                        placeholder="Your name"
                    />
                    <Select label="Status" fieldName="status" value={quote.status} onFieldChange={handleFieldChange}>
                        <option value="Draft">Draft</option>
                        <option value="Quoted">Quoted</option>
                        <option value="Approved">Approved</option>
                        <option value="Lost">Lost</option>
                    </Select>
                </div>
            </div>
            
            <div className="p-4 bg-gray-800 rounded-lg shadow">
                <h3 className="text-lg font-semibold text-white mb-4">Project Codes</h3>
                <div className="form-grid grid-cols-1 md:grid-cols-4">
                    <SelectCode
                        label="Industry"
                        fieldName="industry"
                        value={quote.projectCodes.industry}
                        onFieldChange={handleCodeChange}
                        options={schemas.industry}
                    />
                    <SelectCode
                        label="Product"
                        fieldName="product"
                        value={quote.projectCodes.product}
                        onFieldChange={handleCodeChange}
                        options={schemas.product}
                    />
                    <SelectCode
                        label="Control"
                        fieldName="control"
                        value={quote.projectCodes.control}
                        onFieldChange={handleCodeChange}
                        options={schemas.control}
                    />
                    <SelectCode
                        label="Scope"
                        fieldName="scope"
                        value={quote.projectCodes.scope}
                        onFieldChange={handleCodeChange}
                        options={schemas.scope}
                    />
                </div>
                <div className="mt-6 flex items-center gap-4">
                    <button onClick={generateQuoteId} className="btn btn-primary" disabled={!quote.customer}>
                        Generate Quote Number
                    </button>
                    {generatedNumber && (
                        <div className="p-3 bg-gray-900 rounded-md">
                            <span className="font-mono text-lg text-green-400">{generatedNumber}</span>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}
// --- Step 2: Panel Config ---
function PanelConfig({ quote, setQuote }) {
    const handleConfigChange = (field, value) => {
        setQuote(prev => ({
            ...prev,
            controlPanelConfig: { ...prev.controlPanelConfig, [field]: value }
        }));
    };
    
    const config = quote.controlPanelConfig || {};
    const isAutomated = quote.projectCodes.control === 1; // 1 = Automated

    return (
        <div className="p-4 bg-gray-800 rounded-lg shadow max-w-2xl mx-auto">
            <h3 className="text-lg font-semibold text-white mb-4">Panel Configuration</h3>
            <div className="form-grid">
                <Select label="Voltage" fieldName="voltage" value={config.voltage} onFieldChange={handleConfigChange}>
                    <option value="" disabled>Select...</option>
                    <option value="120V">120V</option>
                    <option value="208V">208V</option>
                    <option value="240V">240V</option>
                    <option value="480V">480V</option>
                    <option value="600V">600V</option>
                </Select>
                <Select label="Phase" fieldName="phase" value={config.phase} onFieldChange={handleConfigChange}>
                    <option value="" disabled>Select...</option>
                    <option value="1-Phase">1-Phase</option>
                    <option value="3-Phase">3-Phase</option>
                </Select>
                <Select label="Enclosure Type" fieldName="enclosureType" value={config.enclosureType} onFieldChange={handleConfigChange}>
                    <option value="" disabled>Select...</option>
                    <option value="NEMA 1">NEMA 1 (Painted)</option>
                    <option value="NEMA 12">NEMA 12 (Painted)</option>
                    <option value="NEMA 4">NEMA 4 (Painted)</option>
                    <option value="NEMA 4X">NEMA 4X (Stainless)</option>
                </Select>
                <Input
                    label="Enclosure Rating (optional)"
                    fieldName="enclosureRating"
                    value={config.enclosureRating}
                    onFieldChange={handleConfigChange}
                    placeholder="E.g., 42x36x12"
                />
                
                {/* Conditional Fields for Automated Panels */}
                {isAutomated && (
                    <>
                        <Select label="HMI Size" fieldName="hmiSize" value={config.hmiSize} onFieldChange={handleConfigChange}>
                            <option value="" disabled>Select...</option>
                            <option value='7"'>7" Screen</option>
                            <option value='10"'>10" Screen</option>
                            <option value='12"'>12" Screen</option>
                            <option value='15"'>15" Screen</option>
                        </Select>
                        <Select label="PLC Platform" fieldName="plcPlatform" value={config.plcPlatform} onFieldChange={handleConfigChange}>
                            <option value="" disabled>Select...</option>
                            <option value="CompactLogix">Allen-Bradley CompactLogix</option>
                            <option value="Micro800">Allen-Bradley Micro800</option>
                            <option value="IDEC">IDEC</option>
                            <option value="Siemens">Siemens</option>
                        </Select>
                    </>
                )}
                {!isAutomated && (
                    <div className="md:col-span-2 p-4 bg-gray-900 rounded-md text-gray-400 flex items-center gap-3">
                        <svg className="w-[18px] h-[18px]" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                        <span>Automation fields (HMI, PLC) are hidden because Control Type is not 'Automated'.</span>
                    </div>
                )}
            </div>
        </div>
    );
}
// --- Step 3: Product Config ---
function ProductConfigurator({ quote, setQuote }) {
    const { product } = quote.projectCodes;

    const handleUpdateList = (listName, newList) => {
        setQuote(prev => ({
            ...prev,
            productConfiguration: { ...prev.productConfiguration, [listName]: newList }
        }));
    };

    const getVisibleSections = () => {
        // This logic will be driven by the Product Template Manager in the future
        // For now, we hard-code it based on productCode
        const code = product;
        if (!code) return [];

        if (code >= 100 && code <= 109) return ['motors', 'heaters', 'inputs', 'outputs']; // Brewhouse
        if (code >= 140 && code <= 149) return ['motors']; // Motor Control
        if ((code >= 120 && code <= 129) || (code >= 160 && code <= 169)) return ['inputs', 'outputs']; // Cellar, CIP
        
        return [];
    };

    const sections = getVisibleSections();

    if (sections.length === 0) {
        return (
            <div className="p-4 bg-gray-800 rounded-lg shadow max-w-2xl mx-auto text-center">
                <h3 className="text-lg font-semibold text-white">Product Configuration</h3>
                <p className="mt-2 text-gray-400">Please select a Product in "Step 1" to see its configuration options.</p>
            </div>
        );
    }
    
    const config = quote.productConfiguration;

    return (
        <div className="space-y-6 max-w-4xl mx-auto">
            <h3 className="text-xl font-semibold text-white text-center">Product Configuration</h3>
            {sections.includes('motors') && (
                <ItemListManager
                    title="Motors"
                    items={config.motors}
                    setItems={newList => handleUpdateList('motors', newList)}
                    itemFields={[
                        { name: "name", label: "Name", type: "text", placeholder: "E.g., Auger Motor" },
                        { name: "hp", label: "HP", type: "text", placeholder: "1.5" },
                        { name: "controlType", label: "Control", type: "select", options: [{value: "VFD", label: "VFD"}, {value: "On/Off", label: "On/Off"}] },
                        { name: "volt", label: "Voltage", type: "text", placeholder: "480V" },
                        { name: "phase", label: "Phase", type: "text", placeholder: "3-Phase" },
                    ]}
                />
            )}
            {sections.includes('heaters') && (
                <ItemListManager
                    title="Heaters"
                    items={config.heaters}
                    setItems={newList => handleUpdateList('heaters', newList)}
                    itemFields={[
                        { name: "name", label: "Name", type: "text", placeholder: "E.g., HLT Element" },
                        { name: "kw", label: "kW", type: "text", placeholder: "5.5" },
                        { name: "controlType", label: "Control", type: "select", options: [{value: "SSR", label: "SSR (Modulating)"}, {value: "On/Off", label: "On/Off"}] },
                    ]}
                />
            )}
            {sections.includes('inputs') && (
                <ItemListManager
                    title="Inputs (Sensors, Manual)"
                    items={config.inputs}
                    setItems={newList => handleUpdateList('inputs', newList)}
                    itemFields={[
                        { name: "name", label: "Name", type: "text", placeholder: "E.g., HLT Level" },
                        { name: "type", label: "Type", type: "text", placeholder: "Analog (4-20mA)" },
                    ]}
                />
            )}
            {sections.includes('outputs') && (
                <ItemListManager
                    title="Outputs (Valves, etc)"
                    items={config.outputs}
                    setItems={newList => handleUpdateList('outputs', newList)}
                    itemFields={[
                        { name: "name", label: "Name", type: "text", placeholder: "E.g., Mash Tun Valve" },
                        { name: "type", label: "Type", type: "text", placeholder: "24VDC Solenoid" },
                    ]}
                />
            )}
        </div>
    );
}

// --- Helper for Step 3: ItemListManager ---
function ItemListManager({ title, items, setItems, itemFields }) {
    const [editItemId, setEditItemId] = useState(null);
    const [editItemData, setEditItemData] = useState({});

    const handleAddItem = () => {
        const newItem = { id: `item-${Date.now()}`, ...itemFields.reduce((acc, f) => ({...acc, [f.name]: ''}), {}) };
        setItems([...items, newItem]);
        setEditItemId(newItem.id);
        setEditItemData(newItem);
    };

    const handleEdit = (item) => {
        setEditItemId(item.id);
        setEditItemData(item);
    };

    const handleSave = () => {
        setItems(items.map(item => item.id === editItemId ? editItemData : item));
        setEditItemId(null);
        setEditItemData({});
    };
    
    const handleCancel = () => {
        setEditItemId(null);
        setEditItemData({});
    };

    const handleDelete = (id) => {
        setItems(items.filter(item => item.id !== id));
    };
    
    const handleFieldChange = (e) => {
        setEditItemData(prev => ({...prev, [e.target.name]: e.target.value}));
    };
    
    const renderItemRow = (item) => (
        <div key={item.id} className="p-3 bg-gray-900 rounded-md flex justify-between items-center">
            <div className="flex-1">
                <p className="font-medium text-white">{item[itemFields[0].name] || `(New ${title.slice(0, -1)})`}</p>
                <p className="text-sm text-gray-400">
                    {itemFields.slice(1).map(f => item[f.name]).filter(Boolean).join(' / ')}
                </p>
            </div>
            <div className="flex gap-2">
                <button onClick={() => handleEdit(item)} className="btn btn-secondary btn-sm py-1 px-2 text-sm">Edit</button>
                <button onClick={() => handleDelete(item.id)} className="btn btn-danger btn-sm py-1 px-2 text-sm">
                    <svg className="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg>
                </button>
            </div>
        </div>
    );
    
    const renderEditForm = () => (
        <div className="p-4 bg-gray-900 rounded-md space-y-4">
            <h4 className="text-lg font-semibold text-white">
                {items.find(i => i.id === editItemId)?.[itemFields[0].name] ? "Edit" : "Add"} {title.slice(0, -1)}
            </h4>
            <div className="form-grid">
                {itemFields.map(field => (
                    <div key={field.name}>
                        <label className="label">{field.label}</label>
                        {field.type === 'select' ? (
                            <select name={field.name} value={editItemData[field.name] || ''} onChange={handleFieldChange} className="input-base">
                                <option value="" disabled>Select...</option>
                                {field.options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                            </select>
                        ) : (
                            <input 
                                type={field.type} 
                                name={field.name} 
                                placeholder={field.placeholder}
                                value={editItemData[field.name] || ''} 
                                onChange={handleFieldChange}
                                className="input-base"
                            />
                        )}
                    </div>
                ))}
            </div>
            <div className="flex gap-2">
                <button onClick={handleSave} className="btn btn-primary">Save</button>
                <button onClick={handleCancel} className="btn btn-secondary">Cancel</button>
            </div>
        </div>
    );

    return (
        <div className="p-4 bg-gray-800 rounded-lg shadow">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold text-white">{title}</h3>
                <button onClick={handleAddItem} className="btn btn-secondary btn-sm">
                    <svg className="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
                    Add
                </button>
            </div>
            <div className="space-y-2">
                {items.map(item => (
                    editItemId === item.id ? renderEditForm() : renderItemRow(item)
                ))}
                {items.length === 0 && <p className="text-gray-400 text-sm">No {title.toLowerCase()} added yet.</p>}
                {editItemId && !items.some(i => i.id === editItemId) && renderEditForm()}
            </div>
        </div>
    );
}
// --- Step 4: BOM Assistance ---
function BomAssistance({ quote, setQuote }) {
    const [searchTerm, setSearchTerm] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [isSearching, setIsSearching] = useState(false);
    const [selectedItems, setSelectedItems] = useState(quote.bom || []);
    const [showResults, setShowResults] = useState(false);

    const handleSearch = async () => {
        if (!searchTerm.trim()) return;
        
        setIsSearching(true);
        try {
            const results = await window.assemblies.search({ description: searchTerm.trim() });
            setSearchResults(results);
            setShowResults(true);
        } catch (error) {
            console.error('Search failed:', error);
            setSearchResults([]);
        } finally {
            setIsSearching(false);
        }
    };

    const handleAddToBom = (item) => {
        const existing = selectedItems.find(i => i.id === item.id);
        if (existing) {
            setSelectedItems(selectedItems.map(i => 
                i.id === item.id ? { ...i, quantity: i.quantity + 1 } : i
            ));
        } else {
            setSelectedItems([...selectedItems, { ...item, quantity: 1 }]);
        }
    };

    const handleUpdateQuantity = (id, quantity) => {
        if (quantity <= 0) {
            setSelectedItems(selectedItems.filter(i => i.id !== id));
        } else {
            setSelectedItems(selectedItems.map(i => 
                i.id === id ? { ...i, quantity } : i
            ));
        }
    };

    const handleRemoveFromBom = (id) => {
        setSelectedItems(selectedItems.filter(i => i.id !== id));
    };

    // Update quote when selectedItems changes
    useEffect(() => {
        setQuote(prev => ({ ...prev, bom: selectedItems }));
    }, [selectedItems, setQuote]);

    const totalCost = selectedItems.reduce((sum, item) => sum + (item.cost * item.quantity), 0);

    return (
        <div className="space-y-6 max-w-6xl mx-auto">
            <h3 className="text-xl font-semibold text-white text-center">BOM Assistance</h3>
            
            {/* Search Section */}
            <div className="p-4 bg-gray-800 rounded-lg shadow">
                <h4 className="text-lg font-semibold text-white mb-4">Search Assemblies</h4>
                <div className="flex gap-4">
                    <input
                        type="text"
                        placeholder="Search for assemblies, parts, or components..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                        className="input-base flex-1"
                    />
                    <button 
                        onClick={handleSearch} 
                        disabled={isSearching || !searchTerm.trim()}
                        className="btn btn-primary"
                    >
                        {isSearching ? 'Searching...' : 'Search'}
                    </button>
                </div>
                
                {showResults && (
                    <div className="mt-4">
                        <h5 className="text-white font-medium mb-2">Search Results</h5>
                        {searchResults.length === 0 ? (
                            <p className="text-gray-400">No results found.</p>
                        ) : (
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {searchResults.map(item => (
                                    <div key={item.id} className="p-3 bg-gray-900 rounded-md flex justify-between items-center">
                                        <div className="flex-1">
                                            <p className="font-medium text-white">{item.name}</p>
                                            <p className="text-sm text-gray-400">{item.description}</p>
                                            <p className="text-sm text-green-400">${item.cost}</p>
                                        </div>
                                        <button 
                                            onClick={() => handleAddToBom(item)}
                                            className="btn btn-secondary btn-sm"
                                        >
                                            Add to BOM
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
            </div>

            {/* BOM Section */}
            <div className="p-4 bg-gray-800 rounded-lg shadow">
                <div className="flex justify-between items-center mb-4">
                    <h4 className="text-lg font-semibold text-white">Bill of Materials</h4>
                    <div className="text-right">
                        <p className="text-sm text-gray-400">Total Cost</p>
                        <p className="text-xl font-bold text-green-400">${totalCost.toFixed(2)}</p>
                    </div>
                </div>
                
                {selectedItems.length === 0 ? (
                    <p className="text-gray-400">No items in BOM. Search and add assemblies above.</p>
                ) : (
                    <div className="space-y-2">
                        {selectedItems.map(item => (
                            <div key={item.id} className="p-3 bg-gray-900 rounded-md flex justify-between items-center">
                                <div className="flex-1">
                                    <p className="font-medium text-white">{item.name}</p>
                                    <p className="text-sm text-gray-400">{item.description}</p>
                                    <p className="text-sm text-green-400">${item.cost} each</p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button 
                                        onClick={() => handleUpdateQuantity(item.id, item.quantity - 1)}
                                        className="btn btn-secondary btn-sm px-2"
                                    >
                                        -
                                    </button>
                                    <span className="text-white min-w-[3rem] text-center">{item.quantity}</span>
                                    <button 
                                        onClick={() => handleUpdateQuantity(item.id, item.quantity + 1)}
                                        className="btn btn-secondary btn-sm px-2"
                                    >
                                        +
                                    </button>
                                    <button 
                                        onClick={() => handleRemoveFromBom(item.id)}
                                        className="btn btn-danger btn-sm ml-2"
                                    >
                                        <svg className="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

        // --- Main App Component ---
        function App() {
            const [currentStep, setCurrentStep] = useState(1);
            const [quote, setQuote] = useState({
                id: null,
                projectCodes: { industry: '', product: '', control: '', scope: '' },
                projectDetails: { name: '', description: '', notes: '' },
                panelConfiguration: { panels: [] },
                productConfiguration: { motors: [], heaters: [], inputs: [], outputs: [] },
                bom: []
            });
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [generatedNumber, setGeneratedNumber] = useState('');
            const [schemas, setSchemas] = useState({});
            const [customers, setCustomers] = useState([]);

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const s = await getSchemas();
                        const c = await getCustomers();
                        setSchemas(s);
                        setCustomers(c);
                    } catch (error) {
                        console.error('Error loading data:', error);
                    }
                };
                loadData();
            }, []);    const steps = [
        { id: 1, title: 'Project Setup', component: ProjectDetails },
        { id: 2, title: 'Panel Config', component: PanelConfig },
        { id: 3, title: 'Product Config', component: ProductConfigurator },
        { id: 4, title: 'BOM Assistance', component: BomAssistance }
    ];

    const handleNext = () => {
        if (currentStep < steps.length) {
            setCurrentStep(currentStep + 1);
        }
    };

    const handlePrev = () => {
        if (currentStep > 1) {
            setCurrentStep(currentStep - 1);
        }
    };

    const handleSave = async () => {
        setIsLoading(true);
        setMessage('');
        try {
            const savedQuote = await window.quotes.save(quote);
            setQuote(savedQuote);
            setMessage('Quote saved successfully!');
        } catch (error) {
            console.error('Save failed:', error);
            setMessage('Failed to save quote. Please try again.');
        } finally {
            setIsLoading(false);
        }
    };

    const handleLoad = async (quoteId) => {
        setIsLoading(true);
        setMessage('');
        try {
            const loadedQuote = await window.quotes.get(quoteId);
            setQuote(loadedQuote);
            setMessage('Quote loaded successfully!');
        } catch (error) {
            console.error('Load failed:', error);
            setMessage('Failed to load quote. Please try again.');
        } finally {
            setIsLoading(false);
        }
    };

    const currentStepData = steps.find(s => s.id === currentStep);
    const CurrentComponent = currentStepData.component;

    return (
        <div className="min-h-screen bg-gray-900 text-white p-6">
            <div className="max-w-7xl mx-auto">
                {/* Header */}
                <div className="mb-8 text-center">
                    <h1 className="text-3xl font-bold text-white mb-2">Quote Configurator</h1>
                    <p className="text-gray-400">Configure quotes for Craft Automation products</p>
                </div>

                {/* Progress Bar */}
                <div className="mb-8">
                    <div className="flex justify-between items-center mb-4">
                        {steps.map(step => (
                            <div key={step.id} className="flex items-center">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                                    step.id <= currentStep ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-400'
                                }`}>
                                    {step.id}
                                </div>
                                <span className={`ml-2 text-sm ${step.id <= currentStep ? 'text-white' : 'text-gray-400'}`}>
                                    {step.title}
                                </span>
                                {step.id < steps.length && (
                                    <div className={`w-12 h-0.5 mx-4 ${
                                        step.id < currentStep ? 'bg-blue-600' : 'bg-gray-700'
                                    }`} />
                                )}
                            </div>
                        ))}
                    </div>
                </div>

                {/* Main Content */}
                <div className="mb-8">
                    <CurrentComponent 
                        quote={quote} 
                        setQuote={setQuote} 
                        {...(CurrentComponent === ProjectDetails ? { schemas, customers, generatedNumber, setGeneratedNumber } : {})} 
                    />
                </div>

                {/* Navigation */}
                <div className="flex justify-between items-center">
                    <button 
                        onClick={handlePrev} 
                        disabled={currentStep === 1}
                        className="btn btn-secondary disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Previous
                    </button>
                    
                    <div className="flex gap-4">
                        <button 
                            onClick={handleSave} 
                            disabled={isLoading}
                            className="btn btn-primary"
                        >
                            {isLoading ? 'Saving...' : 'Save Quote'}
                        </button>
                        
                        <button 
                            onClick={() => handleLoad(prompt('Enter Quote ID:'))}
                            className="btn btn-secondary"
                        >
                            Load Quote
                        </button>
                    </div>

                    <button 
                        onClick={handleNext} 
                        disabled={currentStep === steps.length}
                        className="btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Next
                    </button>
                </div>

                {/* Messages */}
                {message && (
                    <div className={`mt-4 p-4 rounded-lg text-center ${
                        message.includes('success') ? 'bg-green-800 text-green-200' : 'bg-red-800 text-red-200'
                    }`}>
                        {message}
                    </div>
                )}
            </div>
        </div>
    );
}

// --- Render the App ---
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
