<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            color-scheme: light;
        }
        body {
            font-family: 'Poppins', 'Inter', sans-serif;
            background-color: var(--sand, #F5E5D0);
            color: var(--slateish, #4A5A63);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .table-cell {
            padding: 8px 12px;
            border-bottom: 1px solid var(--eggshell, #F2EBE1);
        }
        .table-header {
            background-color: var(--eggshell, #F2EBE1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .scrollable-table {
            max-height: 65vh;
            overflow-y: auto;
        }
        /* Custom scrollbar */
        .scrollable-table::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-table::-webkit-scrollbar-track {
            background: var(--sand, #F5E5D0);
        }
        .scrollable-table::-webkit-scrollbar-thumb {
            background: var(--accent, #D67F5C);
            border-radius: 4px;
        }
        .scrollable-table::-webkit-scrollbar-thumb:hover {
            background: #c66d4d;
        }
    </style>
</head>
<body class="p-4">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Use the Electron API exposed via preload.js
        const api = {
            components: window.components,
            assemblies: window.assemblies,
            quotes: window.quotes
        };

        function BOMBuilder() {
            // Data Libraries
            const [allComponents, setAllComponents] = useState([]);
            const [allAssemblies, setAllAssemblies] = useState([]);
            const [allQuotes, setAllQuotes] = useState([]);

            // Current BOM State
            const [currentBOM, setCurrentBOM] = useState({
                bomId: `BOM-${Date.now().toString().slice(-6)}`,
                quoteId: '',
                description: '',
                assemblies: [],
                oneOffComponents: []
            });

            // BOM Expansion Result
            const [expandedBOM, setExpandedBOM] = useState(null);

            // Form state
            const [asmAddId, setAsmAddId] = useState('');
            const [compAddSku, setCompAddSku] = useState('');

            // Loading state
            const [isSaving, setIsSaving] = useState(false);
            const [isExpanding, setIsExpanding] = useState(false);
            const [isExporting, setIsExporting] = useState(false);

            // Component search modal state
            const [showComponentModal, setShowComponentModal] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            // Filters: Part, Assembly, Tags (replacing Vendor/Category)
            const [selectedPart, setSelectedPart] = useState('');
            const [selectedAssembly, setSelectedAssembly] = useState(''); // assemblyId
            const [selectedTag, setSelectedTag] = useState('');
            // Ref for modal list scroll container
            const listRef = React.useRef(null);
            // Sorting state
            const [sortBy, setSortBy] = useState('relevance'); // 'relevance' | 'sku' | 'assembly'

            // Load all data libraries on mount
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const [components, assemblies, quotes] = await Promise.all([
                            api.components.getAll(),
                            api.assemblies.getAll(),
                            api.quotes.getAll()
                        ]);
                        setAllComponents(components);
                        setAllAssemblies(assemblies);
                        setAllQuotes(quotes);
                    } catch (err) {
                        console.error('Error loading data:', err);
                    }
                };
                loadData();
            }, []);

            // Re-calculate BOM whenever the BOM definition changes
            useEffect(() => {
                const expandBOM = async () => {
                    if (currentBOM.assemblies.length > 0 || currentBOM.oneOffComponents.length > 0) {
                        try {
                            setIsExpanding(true);
                            const bomComponents = [];

                            // Expand assemblies
                            for (const pa of currentBOM.assemblies) {
                                const assembly = allAssemblies.find(a => a.assemblyId === pa.assemblyId);
                                if (!assembly) continue;

                                if (assembly.components) {
                                    for (const ac of assembly.components) {
                                        const component = allComponents.find(c => c.sku === ac.sku);
                                        const qty = ac.quantity * pa.quantity;
                                        const subtotal = component ? (component.price || component.cost || 0) * qty : 0;

                                        bomComponents.push({
                                            sku: ac.sku,
                                            component: component || null,
                                            quantity: qty,
                                            subtotal,
                                            source: `Assembly: ${assembly.description}`,
                                            notes: ac.notes
                                        });
                                    }
                                }
                            }

                            // Add one-off components
                            for (const oc of currentBOM.oneOffComponents) {
                                const component = allComponents.find(c => c.sku === oc.sku);
                                const subtotal = component ? (component.price || component.cost || 0) * oc.quantity : 0;

                                bomComponents.push({
                                    sku: oc.sku,
                                    component: component || null,
                                    quantity: oc.quantity,
                                    subtotal,
                                    source: 'One-off',
                                    notes: oc.notes
                                });
                            }

                            const totalCost = bomComponents.reduce((sum, item) => sum + item.subtotal, 0);

                            setExpandedBOM({
                                bom: bomComponents,
                                totalCost
                            });
                        } catch (err) {
                            console.error('Error expanding BOM:', err);
                            setExpandedBOM(null);
                        } finally {
                            setIsExpanding(false);
                        }
                    } else {
                        setExpandedBOM(null);
                    }
                };

                // Debounce expansion to avoid too many calculations
                const timeoutId = setTimeout(expandBOM, 500);
                return () => clearTimeout(timeoutId);
            }, [currentBOM, allComponents, allAssemblies]);

            const handleBOMInfoChange = (e) => {
                const { name, value } = e.target;
                setCurrentBOM(prev => ({ ...prev, [name]: value }));
            };

            const handleImportLastQuote = async () => {
                try {
                    // Check if we're in Electron context
                    if (!window.electronAPI?.db?.loadProjects && !window.db?.loadProjects) {
                        alert('Database API not available. This feature requires the Electron app.');
                        return;
                    }

                    // Use whichever API is available
                    const dbAPI = window.db || window.electronAPI.db;
                    const projects = await dbAPI.loadProjects();

                    if (projects && projects.length > 0) {
                        // Sort by creation date and get the most recent
                        const sortedProjects = projects.sort((a, b) =>
                            new Date(b.createdAt) - new Date(a.createdAt)
                        );
                        const lastQuote = sortedProjects[0].quoteNumber;

                        if (lastQuote) {
                            setCurrentBOM(prev => ({ ...prev, quoteId: lastQuote }));
                            alert(`Imported: ${lastQuote}`);
                        } else {
                            alert('No quote number found in last project.');
                        }
                    } else {
                        alert('No projects found. Generate a quote in the Generator first.');
                    }
                } catch (err) {
                    console.error('Error importing last quote:', err);
                    alert(`Error importing quote: ${err.message}`);
                }
            };

            const handleAddAssembly = (e) => {
                e.preventDefault();
                if (!asmAddId) return;

                setCurrentBOM(prev => {
                    const existing = prev.assemblies.find(a => a.assemblyId === asmAddId);
                    let newAssemblies;
                    if (existing) {
                        newAssemblies = prev.assemblies.map(a =>
                            a.assemblyId === asmAddId ? { ...a, quantity: a.quantity + 1 } : a
                        );
                    } else {
                        newAssemblies = [...prev.assemblies, { assemblyId: asmAddId, quantity: 1 }];
                    }
                    return { ...prev, assemblies: newAssemblies };
                });
                setAsmAddId(''); // Clear selection
            };

            const handleAddComponent = (e) => {
                e.preventDefault();
                if (!compAddSku) return;

                setCurrentBOM(prev => {
                    const existing = prev.oneOffComponents.find(c => c.sku === compAddSku);
                    let newComponents;
                    if (existing) {
                        newComponents = prev.oneOffComponents.map(c =>
                            c.sku === compAddSku ? { ...c, quantity: c.quantity + 1 } : c
                        );
                    } else {
                        newComponents = [...prev.oneOffComponents, { sku: compAddSku, quantity: 1 }];
                    }
                    return { ...prev, oneOffComponents: newComponents };
                });
                setCompAddSku(''); // Clear selection
            };

            const handleQuantityChange = (type, identifier, newQty) => {
                const qty = parseInt(newQty, 10);
                if (isNaN(qty) || qty < 0) return;

                setCurrentBOM(prev => {
                    if (type === 'assembly') {
                        const newAssemblies = qty === 0
                            ? prev.assemblies.filter(a => a.assemblyId !== identifier)
                            : prev.assemblies.map(a =>
                                a.assemblyId === identifier ? { ...a, quantity: qty } : a
                            );
                        return { ...prev, assemblies: newAssemblies };
                    } else {
                        const newComponents = qty === 0
                            ? prev.oneOffComponents.filter(c => c.sku !== identifier)
                            : prev.oneOffComponents.map(c =>
                                c.sku === identifier ? { ...c, quantity: qty } : c
                            );
                        return { ...prev, oneOffComponents: newComponents };
                    }
                });
            };

            const handleRemoveItem = (type, identifier) => {
                setCurrentBOM(prev => {
                    if (type === 'assembly') {
                        return { ...prev, assemblies: prev.assemblies.filter(a => a.assemblyId !== identifier) };
                    } else {
                        return { ...prev, oneOffComponents: prev.oneOffComponents.filter(c => c.sku !== identifier) };
                    }
                });
            };

            const handleSaveBOM = async () => {
                try {
                    setIsSaving(true);

                    // Create quote object with BOM data
                    const quoteObject = {
                        quoteId: currentBOM.quoteId || `CQ${Date.now().toString().slice(-6)}`,
                        description: currentBOM.description,
                        bomId: currentBOM.bomId,
                        bom: expandedBOM,
                        createdAt: new Date().toISOString(),
                        status: 'draft'
                    };

                    await api.quotes.save(quoteObject);
                    alert(`BOM saved to quote ${quoteObject.quoteId} successfully!`);

                    // Reload quotes list
                    const quotes = await api.quotes.getAll();
                    setAllQuotes(quotes);
                } catch (err) {
                    console.error("Error saving BOM:", err);
                    alert("Error saving BOM. Check console for details.");
                } finally {
                    setIsSaving(false);
                }
            };

            const handleExportBOM = async () => {
                try {
                    setIsExporting(true);

                    if (!expandedBOM || !expandedBOM.bom) {
                        alert('No BOM data to export');
                        return;
                    }

                    // Create CSV content
                    const csvHeader = 'SKU,Description,Quantity,Unit Cost,Total Cost,Source,Notes\n';
                    const csvRows = expandedBOM.bom.map(item =>
                        `"${item.sku}","${item.component?.description || 'Unknown'}",${item.quantity},"$${item.component?.price || item.component?.cost || 0}","$${item.subtotal.toFixed(2)}","${item.source}","${item.notes || ''}"`
                    ).join('\n');

                    const csvContent = csvHeader + csvRows;

                    // Save to OUTPUT/BOMs folder instead of browser download
                    const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
                    const filename = `BOM_${currentBOM.bomId}_${timestamp}.csv`;
                    await window.app.writeFile(`OUTPUT/BOMs/${filename}`, csvContent);

                    alert(`BOM exported successfully to OUTPUT/BOMs/${filename}!`);
                } catch (err) {
                    console.error('Error exporting BOM:', err);
                    alert('Error exporting BOM. Check console for details.');
                } finally {
                    setIsExporting(false);
                }
            };

            const handleLoadQuote = async (quote) => {
                if (quote.bomId && quote.bom) {
                    setCurrentBOM({
                        bomId: quote.bomId,
                        quoteId: quote.quoteId,
                        description: quote.description || '',
                        assemblies: [], // Would need to reverse-engineer from BOM
                        oneOffComponents: [] // Would need to reverse-engineer from BOM
                    });
                    setExpandedBOM(quote.bom);
                } else {
                    alert('This quote does not contain BOM data');
                }
            };

            const createNewBOM = () => {
                setCurrentBOM({
                    bomId: `BOM-${Date.now().toString().slice(-6)}`,
                    quoteId: '',
                    description: '',
                    assemblies: [],
                    oneOffComponents: []
                });
                setExpandedBOM(null);
            };

            // Get unique categories and vendors for filters
            // Build dropdown options
            const partSkus = React.useMemo(() => {
                const s = new Set(allComponents.map(c => (c.sku || '').toString().trim()).filter(Boolean));
                return Array.from(s).sort((a, b) => a.localeCompare(b));
            }, [allComponents]);

            const assemblyOptions = React.useMemo(() => {
                return allAssemblies.map(a => ({ id: a.assemblyId, label: `${a.description} (${a.assemblyId})` }));
            }, [allAssemblies]);

            // Assembly label lookup and reverse index sku -> [assemblyIds]
            const assemblyIdToLabel = React.useMemo(() => {
                const m = new Map();
                allAssemblies.forEach(a => m.set(a.assemblyId, `${a.description} (${a.assemblyId})`));
                return m;
            }, [allAssemblies]);

            const skuToAssemblies = React.useMemo(() => {
                const map = new Map();
                allAssemblies.forEach(a => {
                    (a.components || []).forEach(c => {
                        if (!c?.sku) return;
                        if (!map.has(c.sku)) map.set(c.sku, []);
                        map.get(c.sku).push(a.assemblyId);
                    });
                });
                return map;
            }, [allAssemblies]);

            const assemblySkuMap = React.useMemo(() => {
                const map = new Map();
                allAssemblies.forEach(a => {
                    const set = new Set((a.components || []).map(c => c.sku));
                    map.set(a.assemblyId, set);
                });
                return map;
            }, [allAssemblies]);

            const tags = React.useMemo(() => {
                const s = new Set();
                allComponents.forEach(c => {
                    const raw = c.attributes?.tags;
                    if (!raw) return;
                    const arr = raw.split(',').map(t => t.trim()).filter(Boolean);
                    arr.forEach(t => s.add(t));
                });
                return Array.from(s).sort((a, b) => a.localeCompare(b));
            }, [allComponents]);

            // Filter components based on search and filters
            const filteredComponents = React.useMemo(() => {
                const term = (searchTerm || '').trim().toLowerCase();
                const filtered = allComponents.filter(comp => {
                    const descL = (comp.description || '').toLowerCase();
                    const skuL = (comp.sku || '').toLowerCase();
                    const partVal = (comp.partNumber || comp.part || comp.attributes?.vndrnum || '').toString();
                    const partL = partVal.toLowerCase();
                    const matchesSearch = !term || descL.includes(term) || skuL.includes(term) || partL.includes(term);
                    const matchesPart = !selectedPart || (comp.sku === selectedPart);
                    let matchesAssembly = true;
                    if (selectedAssembly) {
                        const set = assemblySkuMap.get(selectedAssembly);
                        matchesAssembly = !!set && set.has(comp.sku);
                    }
                    let matchesTag = true;
                    if (selectedTag) {
                        const raw = comp.attributes?.tags || '';
                        const arr = raw.split(',').map(t => t.trim().toLowerCase());
                        matchesTag = arr.includes(selectedTag.toLowerCase());
                    }
                    return matchesSearch && matchesPart && matchesAssembly && matchesTag;
                });
                // Sorting strategies
                if (sortBy === 'relevance' && term) {
                    const scoreFor = (c) => {
                        const skuL = (c.sku || '').toLowerCase();
                        const descL = (c.description || '').toLowerCase();
                        const partL = (c.partNumber || c.part || c.attributes?.vndrnum || '').toString().toLowerCase();
                        let score = 0;
                        if (skuL === term) score += 100000;
                        if (skuL.startsWith(term)) score += 50000;
                        if (descL.startsWith(term)) score += 30000;
                        if (partL.startsWith(term)) score += 25000;
                        const skuIdx = skuL.indexOf(term);
                        if (skuIdx >= 0) score += 15000 + Math.max(0, 1000 - skuIdx);
                        const descIdx = descL.indexOf(term);
                        if (descIdx >= 0) score += 12000 + Math.max(0, 1000 - descIdx);
                        const partIdx = partL.indexOf(term);
                        if (partIdx >= 0) score += 10000 + Math.max(0, 1000 - partIdx);
                        if (selectedPart && ((c.partNumber || c.part || c.attributes?.vndrnum) === selectedPart)) score += 50;
                        if (selectedAssembly) score += 25;
                        if (selectedTag) score += 25;
                        return score;
                    };
                    filtered.sort((a, b) => {
                        const sb = scoreFor(b) - scoreFor(a);
                        if (sb !== 0) return sb;
                        const aSku = a.sku || '';
                        const bSku = b.sku || '';
                        if (aSku.length !== bSku.length) return aSku.length - bSku.length;
                        return aSku.localeCompare(bSku);
                    });
                } else if (sortBy === 'assembly') {
                    const getKey = (c) => {
                        const list = skuToAssemblies.get(c.sku) || [];
                        const belongs = selectedAssembly ? list.includes(selectedAssembly) : false;
                        const labels = list.map(id => assemblyIdToLabel.get(id) || id).sort();
                        const first = labels[0] || 'ZZZ';
                        return { belongs, first };
                    };
                    filtered.sort((a, b) => {
                        const ka = getKey(a);
                        const kb = getKey(b);
                        if (ka.belongs !== kb.belongs) return (kb.belongs ? 1 : 0) - (ka.belongs ? 1 : 0);
                        const cmp = ka.first.localeCompare(kb.first);
                        if (cmp !== 0) return cmp;
                        return (a.sku || '').localeCompare(b.sku || '');
                    });
                } else {
                    filtered.sort((a, b) => (a.sku || '').localeCompare(b.sku || ''));
                }
                return filtered;
            }, [allComponents, searchTerm, selectedPart, selectedAssembly, selectedTag, assemblySkuMap, sortBy, skuToAssemblies, assemblyIdToLabel]);

            const handleAddComponentFromModal = (sku) => {
                setCurrentBOM(prev => {
                    const existing = prev.oneOffComponents.find(c => c.sku === sku);
                    let newComponents;
                    if (existing) {
                        newComponents = prev.oneOffComponents.map(c =>
                            c.sku === sku ? { ...c, quantity: c.quantity + 1 } : c
                        );
                    } else {
                        newComponents = [...prev.oneOffComponents, { sku, quantity: 1 }];
                    }
                    return { ...prev, oneOffComponents: newComponents };
                });
            };

            const handleClearFilters = () => {
                setSearchTerm('');
                setSelectedPart('');
                setSelectedAssembly('');
                setSelectedTag('');
            };

            // Ensure the modal results start at the top whenever it opens or filters/search change
            useEffect(() => {
                if (showComponentModal && listRef.current) {
                    try {
                        // Reset scroll position to the top to avoid appearing appended under previous position
                        listRef.current.scrollTo({ top: 0, behavior: 'auto' });
                    } catch (e) {
                        // Fallback for older browsers/contexts
                        listRef.current.scrollTop = 0;
                    }
                }
            }, [showComponentModal, searchTerm, selectedPart, selectedAssembly, selectedTag]);

            return (
                <div className="flex flex-col min-h-screen space-y-4">
                    <h1 className="text-2xl font-bold text-accent">BOM Builder</h1>

                    {/* Top Row: BOM List & Actions */}
                    <div className="flex flex-col lg:flex-row gap-4">
                        <div className="w-full lg:w-1/3 bg-white p-3 rounded-lg shadow-lg">
                            <h2 className="text-lg font-semibold mb-2 text-accent">Saved BOMs</h2>
                            <button
                                onClick={createNewBOM}
                                className="w-full bg-accent hover:bg-orange-600 text-white font-bold py-2 px-4 rounded mb-2 transition-colors">
                                + Create New BOM
                            </button>
                            <div className="max-h-48 overflow-y-auto">
                                {allQuotes.filter(q => q.bom).length === 0 && <p className="text-gray-400">No BOMs saved yet.</p>}
                                {allQuotes.filter(q => q.bom).map((quote, idx) => (
                                    <div key={quote.quoteId + '-' + idx}
                                         className="p-2 bg-gray-50 hover:bg-gray-100 rounded mb-1 flex justify-between items-center group">
                                        <div onClick={() => handleLoadQuote(quote)} className="flex-1 cursor-pointer">
                                            <p className="font-semibold text-accent">{quote.bomId || quote.quoteId}</p>
                                            <p className="text-sm text-gray-300">{quote.description || 'No description'}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex-1 bg-white p-3 rounded-lg shadow-lg">
                            <h2 className="text-lg font-semibold mb-2 text-accent">BOM Details</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                <input
                                    type="text"
                                    name="bomId"
                                    value={currentBOM.bomId}
                                    onChange={handleBOMInfoChange}
                                    placeholder="BOM ID"
                                    className="bg-white text-slateish p-2 rounded col-span-1 md:col-span-2 lg:col-span-3 border border-gray-300 focus:border-accent focus:outline-none"
                                />
                                <div className="col-span-1 md:col-span-2 flex flex-col sm:flex-row gap-2">
                                    <input
                                        type="text"
                                        name="quoteId"
                                        value={currentBOM.quoteId || ''}
                                        onChange={handleBOMInfoChange}
                                        placeholder="Quote ID (e.g., CQ25...)"
                                        className="flex-1 bg-[#3d3935] text-[#f5f0ea] p-2 rounded border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none"
                                    />
                                    <button
                                        onClick={handleImportLastQuote}
                                        className="bg-[#4d4945] hover:bg-[#5d5955] text-[#f5f0ea] px-2 py-2 rounded transition-colors whitespace-nowrap w-full sm:w-auto"
                                        aria-label="Import last quote"
                                        title="Import last quote">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"/></svg>
                                        <span className="sr-only">Import</span>
                                    </button>
                                </div>
                                <input
                                    type="text"
                                    name="description"
                                    value={currentBOM.description}
                                    onChange={handleBOMInfoChange}
                                    placeholder="BOM Description (e.g., Main Control System)"
                                    className="bg-[#3d3935] text-[#f5f0ea] p-2 rounded col-span-1 md:col-span-2 lg:col-span-3 border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none"
                                />
                            </div>

                            {/* Current BOM Contents Preview */}
                            <div className="mt-3 text-sm">
                                <p className="text-gray-400 mb-1">
                                    <span className="font-semibold text-[#ff6f29]">{currentBOM.assemblies.length}</span> assemblies,
                                    <span className="font-semibold text-[#ff6f29] ml-1">{currentBOM.oneOffComponents.length}</span> one-off components
                                </p>
                            </div>
                        </div>

                        <div className="w-full lg:w-1/4 bg-[#2d2925] p-3 rounded-lg shadow-lg text-center">
                            <h2 className="text-lg font-semibold text-[#ff6f29]">Total Cost</h2>
                            <p className="text-4xl font-bold text-green-400">
                                ${expandedBOM ? expandedBOM.totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}
                            </p>
                            <button
                                onClick={handleSaveBOM}
                                disabled={isSaving || !expandedBOM}
                                className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white font-bold py-2 px-4 rounded mt-4 transition-colors">
                                {isSaving ? 'Saving...' : 'Save to Quote'}
                            </button>
                            <button
                                onClick={handleExportBOM}
                                disabled={isExporting || !expandedBOM}
                                className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white font-bold py-2 px-4 rounded mt-2 transition-colors">
                                {isExporting ? 'Exporting...' : 'Export CSV'}
                            </button>
                            <button
                                onClick={() => document.getElementById('bomSection')?.scrollIntoView({ behavior: 'smooth' })}
                                className="w-full bg-[#4d4945] hover:bg-[#5d5955] text-[#f5f0ea] font-semibold py-2 px-4 rounded mt-2 transition-colors"
                                title="Scroll to BOM">
                                View BOM
                            </button>
                            {isExpanding && <p className="text-xs text-gray-400 mt-2">Calculating BOM...</p>}
                        </div>
                    </div>

                    {/* Middle Row: Adders */}
                    <div className="flex flex-col lg:flex-row gap-4">
                        {/* Assembly Adder */}
                        <form onSubmit={handleAddAssembly} className="flex-1 bg-[#2d2925] p-3 rounded-lg shadow-lg">
                            <label className="block text-lg font-semibold mb-2 text-[#ff6f29]" htmlFor="asm-select">Add Assembly</label>
                            <div className="flex flex-col sm:flex-row gap-2">
                                <select
                                    id="asm-select"
                                    value={asmAddId}
                                    onChange={e => setAsmAddId(e.target.value)}
                                    className="flex-1 bg-[#3d3935] text-[#f5f0ea] p-2 rounded border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none"
                                >
                                    <option value="">Select Assembly...</option>
                                    {allAssemblies.map((asm, idx) => (
                                        <option key={asm.assemblyId + '-' + idx} value={asm.assemblyId}>
                                            {asm.description} ({asm.assemblyId})
                                        </option>
                                    ))}
                                </select>
                                <button
                                    type="submit"
                                    disabled={!asmAddId}
                                    className="bg-[#ff6f29] hover:bg-[#ff8547] disabled:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors w-full sm:w-auto">
                                    Add
                                </button>
                            </div>
                        </form>

                        {/* Component Adder */}
                        <form onSubmit={handleAddComponent} className="flex-1 bg-[#2d2925] p-3 rounded-lg shadow-lg">
                            <label className="block text-lg font-semibold mb-2 text-[#ff6f29]" htmlFor="comp-select">Add One-Off Component</label>
                            <div className="flex flex-col sm:flex-row gap-2">
                                <select
                                    id="comp-select"
                                    value={compAddSku}
                                    onChange={e => setCompAddSku(e.target.value)}
                                    className="flex-1 bg-[#3d3935] text-[#f5f0ea] p-2 rounded border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none"
                                >
                                    <option value="">Select Component...</option>
                                    {allComponents.slice(0, 50).map((comp, idx) => (
                                        <option key={comp.sku + '-' + idx} value={comp.sku}>
                                            {comp.description} ({comp.sku}) - ${comp.cost || comp.price || 0}
                                        </option>
                                    ))}
                                </select>
                                <button
                                    type="submit"
                                    disabled={!compAddSku}
                                    className="bg-[#ff6f29] hover:bg-[#ff8547] disabled:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors w-full sm:w-auto">
                                    Add
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setShowComponentModal(true)}
                                    className="bg-[#4d4945] hover:bg-[#5d5955] text-[#f5f0ea] font-bold py-2 px-4 rounded transition-colors w-full sm:w-auto">
                                    üîç Browse
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* Bottom Row: BOM Table */}
                    <div id="bomSection" className="flex-1 bg-[#2d2925] p-3 rounded-lg shadow-lg overflow-auto flex flex-col">
                        <h2 className="text-xl font-semibold mb-2 text-[#ff6f29]">Expanded Bill of Materials (BOM)</h2>
                        <div className="scrollable-table">
                            <table className="w-full text-left">
                                <thead className="table-header">
                                    <tr className="border-b-2 border-[#ff6f29]">
                                        <th className="table-cell text-[#ff6f29]">SKU / ID</th>
                                        <th className="table-cell text-[#ff6f29]">Description</th>
                                        <th className="table-cell text-[#ff6f29]">Qty</th>
                                        <th className="table-cell text-[#ff6f29]">Source</th>
                                        <th className="table-cell text-right text-[#ff6f29]">Unit Cost</th>
                                        <th className="table-cell text-right text-[#ff6f29]">Total Cost</th>
                                        <th className="table-cell text-[#ff6f29]">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {expandedBOM && expandedBOM.bom && expandedBOM.bom.map((item, index) => (
                                        <tr key={(item.sku || item.assemblyId) + '-' + index} className="hover:bg-[#3d3935] transition-colors">
                                            <td className="table-cell font-mono text-sm">{item.sku}</td>
                                            <td className="table-cell">{item.component?.description || 'Unknown Component'}</td>
                                            <td className="table-cell">
                                                <input
                                                    type="number"
                                                    min="0"
                                                    value={item.quantity}
                                                    onChange={(e) => {
                                                        // Determine if this is from assembly or one-off
                                                        const isOneOff = currentBOM.oneOffComponents.some(c => c.sku === item.sku);
                                                        handleQuantityChange(isOneOff ? 'component' : 'assembly', item.sku || item.assemblyId, e.target.value);
                                                    }}
                                                    className="w-16 bg-[#3d3935] text-[#f5f0ea] p-1 rounded border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none text-center"
                                                />
                                            </td>
                                            <td className="table-cell">
                                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                                    item.source.startsWith('Assembly') ? 'bg-purple-600 text-purple-100' :
                                                    item.source === 'One-off' ? 'bg-yellow-600 text-yellow-100' :
                                                    'bg-blue-600 text-blue-100'
                                                }`}>
                                                    {item.source}
                                                </span>
                                            </td>
                                            <td className="table-cell text-right font-mono text-sm">
                                                ${(item.component?.price || item.component?.cost || 0).toFixed(2)}
                                            </td>
                                            <td className="table-cell text-right font-mono font-semibold">
                                                ${item.subtotal.toFixed(2)}
                                            </td>
                                            <td className="table-cell">
                                                <button
                                                    onClick={() => {
                                                        const isOneOff = currentBOM.oneOffComponents.some(c => c.sku === item.sku);
                                                        handleRemoveItem(isOneOff ? 'component' : 'assembly', item.sku || item.assemblyId);
                                                    }}
                                                    className="text-red-400 hover:text-red-300 px-2 py-1 rounded text-sm"
                                                    title="Remove item">
                                                    ‚úï
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                    {(!expandedBOM || !expandedBOM.bom || expandedBOM.bom.length === 0) && (
                                        <tr>
                                            <td colSpan="7" className="table-cell text-center text-gray-400 py-8">
                                                Add assemblies or components to see the BOM.
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Component Search Modal */}
                    {showComponentModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowComponentModal(false)}>
                            <div className="bg-[#2d2925] rounded-lg shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                {/* Modal Header */}
                                <div className="bg-[#1a1614] p-4 border-b border-[#ff6f29] flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-[#ff6f29]">Component Catalog Browser</h2>
                                    <button
                                        onClick={() => setShowComponentModal(false)}
                                        className="text-[#f5f0ea] hover:text-[#ff6f29] text-3xl leading-none"
                                        aria-label="Close">
                                        √ó
                                    </button>
                                </div>

                                {/* Search and Filters */}
                                <div className="p-4 bg-[#3d3935] border-b border-[#4d4945]">
                                    <div className="grid grid-cols-1 md:grid-cols-6 gap-3">
                                        <input
                                            type="text"
                                            placeholder="Search by SKU, description, part number..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="md:col-span-2 bg-[#2d2925] text-[#f5f0ea] p-2 rounded border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none"
                                            autoFocus
                                        />
                                        <select
                                            value={selectedPart}
                                            onChange={(e) => setSelectedPart(e.target.value)}
                                            className="bg-[#2d2925] text-[#f5f0ea] p-2 rounded border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none">
                                            <option value="">All Parts</option>
                                            {partSkus.map((p, idx) => (
                                                <option key={p + '-' + idx} value={p}>{p}</option>
                                            ))}
                                        </select>
                                        <select
                                            value={selectedAssembly}
                                            onChange={(e) => setSelectedAssembly(e.target.value)}
                                            className="bg-[#2d2925] text-[#f5f0ea] p-2 rounded border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none">
                                            <option value="">All Assemblies</option>
                                            {assemblyOptions.map((opt, idx) => (
                                                <option key={opt.id + '-' + idx} value={opt.id}>{opt.label}</option>
                                            ))}
                                        </select>
                                        <select
                                            value={selectedTag}
                                            onChange={(e) => setSelectedTag(e.target.value)}
                                            className="bg-[#2d2925] text-[#f5f0ea] p-2 rounded border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none">
                                            <option value="">All Tags</option>
                                            {tags.map((t, idx) => (
                                                <option key={t + '-' + idx} value={t}>{t}</option>
                                            ))}
                                        </select>
                                        <select
                                            value={sortBy}
                                            onChange={(e) => setSortBy(e.target.value)}
                                            className="bg-[#2d2925] text-[#f5f0ea] p-2 rounded border border-[#4d4945] focus:border-[#ff6f29] focus:outline-none">
                                            <option value="relevance">Sort: Relevance</option>
                                            <option value="assembly">Sort: Assembly</option>
                                            <option value="sku">Sort: SKU</option>
                                        </select>
                                    </div>
                                    <div className="mt-2 flex justify-between items-center">
                                        <p className="text-sm text-gray-400">
                                            Showing {filteredComponents.length} of {allComponents.length} components
                                        </p>
                                        <button
                                            onClick={handleClearFilters}
                                            className="text-sm text-[#ff6f29] hover:text-[#ff8547] underline">
                                            Clear Filters
                                        </button>
                                    </div>
                                </div>

                                {/* Component List */}
                                <div ref={listRef} className="flex-1 overflow-y-auto p-4">
                                    {filteredComponents.length === 0 ? (
                                        <p className="text-center text-gray-400 py-8">No components found matching your search.</p>
                                    ) : (
                                        <div className="grid grid-cols-1 gap-2">
                                            {filteredComponents.map((comp, idx) => (
                                                <div key={comp.sku + '-' + idx} className="bg-[#3d3935] hover:bg-[#4d4945] p-3 rounded flex justify-between items-center transition-colors">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-3 mb-1">
                                                            <span className="text-xs text-gray-500 mr-2">#{idx + 1}</span>
                                                            <span className="font-mono font-bold text-[#ff6f29]">{comp.sku}</span>
                                                            <span className="text-sm px-2 py-0.5 bg-[#2d2925] rounded text-gray-300">{comp.category}</span>
                                                            {comp.vendor && <span className="text-xs text-gray-400">{comp.vendor}</span>}
                                                        </div>
                                                        <p className="text-[#f5f0ea]">{comp.description}</p>
                                                        {(() => {
                                                            const list = skuToAssemblies.get(comp.sku) || [];
                                                            if (list.length === 0) return null;
                                                            const labels = list.map(id => assemblyIdToLabel.get(id) || id).sort();
                                                            const shown = labels.slice(0, 2);
                                                            const more = labels.length - shown.length;
                                                            return (
                                                                <p className="text-xs text-gray-400 mt-1">
                                                                    Assembly: {shown.join(', ')}{more > 0 ? ` +${more}` : ''}
                                                                </p>
                                                            );
                                                        })()}
                                                        { (comp.partNumber || comp.part || comp.attributes?.vndrnum) && (
                                                            <p className="text-xs text-gray-400 mt-1">Part #: {comp.partNumber || comp.part || comp.attributes?.vndrnum}</p>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-3 ml-4">
                                                        <div className="text-right">
                                                            <p className="text-lg font-bold text-green-400">${(comp.cost || comp.price)?.toFixed(2)}</p>
                                                            {(comp.unit || comp.uom) && <p className="text-xs text-gray-400">per {comp.unit || comp.uom}</p>}
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                handleAddComponentFromModal(comp.sku);
                                                            }}
                                                            className="bg-[#ff6f29] hover:bg-[#ff8547] text-white font-bold py-2 px-4 rounded transition-colors whitespace-nowrap">
                                                            + Add
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Modal Footer */}
                                <div className="bg-[#3d3935] p-4 border-t border-[#4d4945] flex justify-end">
                                    <button
                                        onClick={() => setShowComponentModal(false)}
                                        className="bg-[#4d4945] hover:bg-[#5d5955] text-[#f5f0ea] font-bold py-2 px-6 rounded transition-colors">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BOMBuilder />);
    </script>
</body>
</html>
