<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assembly Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --primary: #c7a783; /* Example primary color */
      --secondary: #f0e6d8;
      --text: #3d2c1d;
      --bg: #fbf9f6;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem;
    }
    .input, .select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      background-color: white;
      transition: border-color 0.2s;
    }
    .input:focus, .select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--secondary);
    }
    .label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.25rem;
      font-size: 0.875rem;
    }
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 600;
      color: white;
      background-color: var(--primary);
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn:hover {
      opacity: 0.8;
    }
    .btn-secondary {
      background-color: #a0aec0;
    }
    .btn-danger {
      background-color: #e53e3e;
    }
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Icon components as inline SVG (no external dependency)
    const Package = ({ size = 16, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/>
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
        <line x1="12" y1="22.08" x2="12" y2="12"/>
      </svg>
    );
    
    const PlusCircle = ({ size = 16, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 8v8"/>
        <path d="M8 12h8"/>
      </svg>
    );
    
    const Save = ({ size = 16, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
        <polyline points="17,21 17,13 7,13 7,21"/>
        <polyline points="7,3 7,8 15,8"/>
      </svg>
    );
    
    const Trash2 = ({ size = 16, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="3,6 5,6 21,6"/>
        <path d="M19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"/>
        <line x1="10" y1="11" x2="10" y2="17"/>
        <line x1="14" y1="11" x2="14" y2="17"/>
      </svg>
    );
    
    const Search = ({ size = 16, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="11" cy="11" r="8"/>
        <path d="M21 21l-4.35-4.35"/>
      </svg>
    );
    
    const X = ({ size = 16, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    );
    
    const ArrowLeft = ({ size = 16, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="19" y1="12" x2="5" y2="12"/>
        <polyline points="12,19 5,12 12,5"/>
      </svg>
    );
    
    const AlertCircle = ({ size = 16, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
    );
    
    const CheckCircle = ({ size = 16, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22,4 12,14.01 9,11.01"/>
      </svg>
    );

    // Simulates the assembly-schema.json category enum
    const ASSEMBLY_CATEGORIES = [
      "Enclosure", "Disconnect", "Fuse", "Branch Breaker", "PWRDST", "Control",
      "SAFETY", "PLC/COM", "MOTOR CONTROL/HEATER CONTROL", "WIRING", "INSTRUMENT", "PNU"
    ];

    // --- Main App Component ---
    function App() {
      const [view, setView] = useState('list'); // 'list' or 'editor'
      const [assemblies, setAssemblies] = useState([]);
      const [currentAssembly, setCurrentAssembly] = useState(null); // Assembly being edited
      const [isLoading, setIsLoading] = useState(true);
      const [statusMessage, setStatusMessage] = useState({ type: '', text: '' });

      // Use the real API
      const api = window.assemblies;
      const componentsApi = window.components;

      const loadAssemblies = async () => {
        setIsLoading(true);
        setStatusMessage({ type: '', text: '' });
        try {
          const data = await api.getAll();
          setAssemblies(data);
        } catch (err) {
          setStatusMessage({ type: 'error', text: 'Failed to load assemblies.' });
          console.error(err);
        } finally {
          setIsLoading(false);
        }
      };

      useEffect(() => {
        loadAssemblies();
      }, []);

      const handleSelectAssembly = (assembly) => {
        setCurrentAssembly(JSON.parse(JSON.stringify(assembly))); // Deep copy
        setView('editor');
      };

      const handleCreateNew = () => {
        setCurrentAssembly({
          assemblyId: "",
          description: "",
          category: ASSEMBLY_CATEGORIES[0],
          components: [],
          estimatedLaborHours: 0
        });
        setView('editor');
      };

      const handleSave = async (assemblyToSave) => {
        setStatusMessage({ type: '', text: '' });
        const result = await api.save(assemblyToSave);

        if (result.success) {
          setStatusMessage({ type: 'success', text: `Assembly "${result.data.assemblyId}" saved.` });
        } else {
          setStatusMessage({ type: 'error', text: 'Failed to save assembly.' });
        }
        await loadAssemblies(); // Refresh list
        setView('list');
      };

      const handleDelete = async (assemblyId) => {
        if (!confirm(`Are you sure you want to delete "${assemblyId}"?`)) {
          return;
        }
        setStatusMessage({ type: '', text: '' });
        const result = await api.delete(assemblyId);

        if (result.success) {
          setStatusMessage({ type: 'success', text: `Assembly "${assemblyId}" deleted.` });
        } else {
          setStatusMessage({ type: 'error', text: 'Failed to delete assembly.' });
        }
        await loadAssemblies(); // Refresh list
      };

      const handleCancel = () => {
        setCurrentAssembly(null);
        setView('list');
      };

      return (
        <div className="container mx-auto max-w-6xl">
          {statusMessage.text && (
            <div className={`alert ${statusMessage.type === 'success' ? 'alert-success' : 'alert-error'} mb-4`}>
              <div className="flex items-center gap-2">
                {statusMessage.type === 'success' ? <CheckCircle size={20} /> : <AlertCircle size={20} />}
                <span className="font-semibold">{statusMessage.text}</span>
              </div>
            </div>
          )}

          {view === 'list' && (
            <AssemblyList
              assemblies={assemblies}
              onCreate={handleCreateNew}
              onEdit={handleSelectAssembly}
              onDelete={handleDelete}
              isLoading={isLoading}
            />
          )}
          {view === 'editor' && (
            <AssemblyEditor
              key={currentAssembly.assemblyId} // Force re-mount on change
              initialAssembly={currentAssembly}
              onSave={handleSave}
              onCancel={handleCancel}
              componentsApi={componentsApi}
              isSaving={false}
            />
          )}
        </div>
      );
    }

    // --- List View Component ---
    function AssemblyList({ assemblies, onCreate, onEdit, onDelete, isLoading }) {
      return (
        <div className="space-y-4">
          <div className="flex justify-between items-center mb-4 pb-4 border-b border-gray-300">
            <h1 className="text-3xl font-bold text-[var(--primary)]">Assembly Manager</h1>
            <button className="btn flex items-center gap-2" onClick={onCreate}>
              <PlusCircle size={18} />
              Create New Assembly
            </button>
          </div>

          {isLoading && <div className="text-center p-4">Loading assemblies...</div>}

          {!isLoading && assemblies.length === 0 && (
            <div className="text-gray-500 text-center p-8 bg-gray-50 rounded-lg">
              <Package size={32} className="mx-auto mb-2" />
              No assemblies found. Create one to get started.
            </div>
          )}

          <div className="space-y-3">
            {assemblies.map(asm => (
              <div key={asm.assemblyId} className="p-4 bg-white rounded-lg shadow-sm border border-gray-200 flex justify-between items-center">
                <div>
                  <h3 className="text-lg font-semibold text-[var(--primary)]">{asm.assemblyId}</h3>
                  <p className="text-gray-600">{asm.description}</p>
                  <span className="text-sm font-medium bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full">{asm.category}</span>
                </div>
                <div className="flex gap-2">
                  <button className="btn" onClick={() => onEdit(asm)}>Edit</button>
                  <button className="btn btn-danger" onClick={() => onDelete(asm.assemblyId)}>Delete</button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // --- Editor View Component ---
    function AssemblyEditor({ initialAssembly, onSave, onCancel, componentsApi, isSaving }) {
      const [assembly, setAssembly] = useState(initialAssembly);
      const [searchTerm, setSearchTerm] = useState("");
      const [searchResults, setSearchResults] = useState([]);
      const [isSearching, setIsSearching] = useState(false);

      // Debounced search effect
      useEffect(() => {
        if (!searchTerm) {
          setSearchResults([]);
          return;
        }

        setIsSearching(true);
        const delay = setTimeout(async () => {
          const results = await componentsApi.search({ description: searchTerm, sku: searchTerm });
          setSearchResults(results);
          setIsSearching(false);
        }, 300); // 300ms debounce

        return () => clearTimeout(delay);
      }, [searchTerm, componentsApi]);

      const handleChange = (e) => {
        const { name, value } = e.target;
        setAssembly(prev => ({ ...prev, [name]: value }));
      };

      const handleAddComponent = (component) => {
        // Prevent adding duplicates
        if (assembly.components.find(c => c.sku === component.sku)) {
          return;
        }

        const newComponent = { sku: component.sku, quantity: 1, notes: "" };
        setAssembly(prev => ({
          ...prev,
          components: [...prev.components, newComponent]
        }));
        setSearchTerm("");
        setSearchResults([]);
      };

      const handleRemoveComponent = (sku) => {
        setAssembly(prev => ({
          ...prev,
          components: prev.components.filter(c => c.sku !== sku)
        }));
      };

      const handleUpdateComponent = (sku, field, value) => {
         setAssembly(prev => ({
          ...prev,
          components: prev.components.map(c =>
            c.sku === sku ? { ...c, [field]: value } : c
          )
        }));
      };

      const handleSaveClick = () => {
        // Basic validation
        if (!assembly.assemblyId || !assembly.description) {
          alert("Assembly ID and Description are required.");
          return;
        }
        onSave(assembly);
      };

      return (
        <div className="space-y-6">
          <button className="font-semibold text-[var(--primary)] flex items-center gap-1" onClick={onCancel}>
            <ArrowLeft size={18} />
            Back to Assembly List
          </button>

          <h1 className="text-3xl font-bold text-[var(--primary)]">
            {initialAssembly.assemblyId ? `Edit: ${initialAssembly.assemblyId}` : "Create New Assembly"}
          </h1>

          {/* --- Assembly Details Form --- */}
          <div className="p-4 border border-gray-200 rounded-lg bg-white/50 space-y-4">
            <h2 className="text-xl font-semibold border-b pb-2">Assembly Details</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="label" htmlFor="assemblyId">Assembly ID</label>
                <input
                  id="assemblyId"
                  name="assemblyId"
                  type="text"
                  className="input"
                  placeholder="e.g., ASM-VFD-1.5HP"
                  value={assembly.assemblyId}
                  onChange={handleChange}
                  disabled={!!initialAssembly.assemblyId} // Don't allow editing ID of existing
                />
              </div>
              <div>
                <label className="label" htmlFor="description">Description</label>
                <input
                  id="description"
                  name="description"
                  type="text"
                  className="input"
                  placeholder="e.g., 1.5HP VFD Starter Kit"
                  value={assembly.description}
                  onChange={handleChange}
                />
              </div>
              <div>
                <label className="label" htmlFor="category">Category</label>
                <select
                  id="category"
                  name="category"
                  className="select"
                  value={assembly.category}
                  onChange={handleChange}
                >
                  {ASSEMBLY_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                </select>
              </div>
            </div>
          </div>

          {/* --- Component Search & Add --- */}
          <div className="p-4 border border-gray-200 rounded-lg bg-white/50 space-y-4">
            <h2 className="text-xl font-semibold border-b pb-2">Add Components to Assembly</h2>
            <div>
              <label className="label" htmlFor="componentSearch">Search Component Catalog (by SKU or Description)</label>
              <div className="relative">
                <input
                  id="componentSearch"
                  type="search"
                  className="input pl-10"
                  placeholder="Search 2000+ components..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
                <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
              </div>
            </div>

            {/* Search Results */}
            {isSearching && <div className="text-gray-500">Searching...</div>}
            {searchResults.length > 0 && (
              <div className="border border-gray-200 rounded-lg max-h-60 overflow-y-auto">
                {searchResults.map(comp => (
                  <div key={comp.sku} className="p-2 flex justify-between items-center border-b last:border-b-0">
                    <div>
                      <span className="font-semibold">{comp.sku}</span>
                      <span className="text-gray-600 ml-2">{comp.description}</span>
                    </div>
                    <button className="btn" onClick={() => handleAddComponent(comp)}>Add</button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* --- Current Components List --- */}
          <div className="p-4 border border-gray-200 rounded-lg bg-white/50 space-y-4">
            <h2 className="text-xl font-semibold border-b pb-2">Current Components in Assembly</h2>
            {assembly.components.length === 0 ? (
              <p className="text-gray-500">No components added yet.</p>
            ) : (
              <div className="space-y-2">
                {assembly.components.map(comp => (
                  <ComponentRow
                    key={comp.sku}
                    component={comp}
                    onRemove={handleRemoveComponent}
                    onUpdate={handleUpdateComponent}
                    componentsApi={componentsApi}
                  />
                ))}
              </div>
            )}
          </div>

          {/* --- Save/Cancel --- */}
          <div className="flex justify-end gap-4">
            <button className="btn btn-secondary" onClick={onCancel} disabled={isSaving}>Cancel</button>
            <button className="btn" onClick={handleSaveClick} disabled={isSaving}>
              {isSaving ? "Saving..." : "Save Assembly"}
            </button>
          </div>
        </div>
      );
    }

    // Helper row for the component list
    function ComponentRow({ component, onRemove, onUpdate, componentsApi }) {
      const [details, setDetails] = useState(null);

      useEffect(() => {
        // Fetch full component details to show description/price
        async function loadDetails() {
          const data = await componentsApi.getBySku(component.sku);
          setDetails(data || { description: "Unknown Component", price: 0 });
        }
        loadDetails();
      }, [component.sku, componentsApi]);

      return (
        <div className="grid grid-cols-4 gap-4 items-center p-2 bg-gray-50 rounded-lg">
          <div>
            <span className="font-semibold block">{component.sku}</span>
            <span className="text-sm text-gray-600">{details ? details.description : "Loading..."}</span>
          </div>
          <div>
            <label className="label" htmlFor={`qty-${component.sku}`}>Quantity</label>
            <input
              id={`qty-${component.sku}`}
              type="number"
              className="input"
              value={component.quantity}
              onChange={(e) => onUpdate(component.sku, 'quantity', parseInt(e.target.value) || 1)}
              min="1"
            />
          </div>
          <div>
            <label className="label" htmlFor={`notes-${component.sku}`}>Notes</label>
             <input
              id={`notes-${component.sku}`}
              type="text"
              className="input"
              placeholder="Optional notes..."
              value={component.notes || ""}
              onChange={(e) => onUpdate(component.sku, 'notes', e.target.value)}
            />
          </div>
          <div className="flex justify-end">
            <button className="btn btn-danger" onClick={() => onRemove(component.sku)}>
              <Trash2 size={18} />
            </button>
          </div>
        </div>
      );
    }

    // --- Render App ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>